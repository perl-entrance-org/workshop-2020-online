# Perl入学式
### 第5回 サブルーチン / Webアプリ編

___
## 諸注意

- Perl入学式の講義は、Youtube Liveにてスライドの表示と講師の説明を配信します。
- 講義中に分からない事や疑問点があれば、★★で質問を発言して下さい。サポーターが適宜回答やアドバイスを行える様にスタンバイしています。
- 講義では、セクション毎に復習を兼ねた練習問題を実際に手を動かしてプログラミングしてもらいます。
  - うまくプログラムが動かない、分からない時は★★でサポーターにヘルプを要請してください。★★のテキスト及び音声チャットにて個別にサポートします。

___
## 講師紹介リファレンス

- 講師・サポーター紹介

___
## 皆さんで自己紹介

___
## 今日の流れ
- サブルーチン

- Webアプリ、その前に
- HTTP の基礎

- Mojolicious の準備
- Mojolicious とは
- Mojolicious::Lite
- Mojolicious 入門
- 簡易 BBS の作成

---
# サブルーチン

___
## サブルーチン
### サブルーチンとは?
プログラムの中で、意味や内容がまとまっている作業をひとかたまりにしたものを **サブルーチン** と呼びます。

Perlにおけるサブルーチンは、「関数」とほぼ同義です。

___
## サブルーチン
### サブルーチンと組み込み関数
Perlには、これまで使ってきた `print` や `join` など、Perlが提供する関数(組み込み関数)が用意されています。

サブルーチンを使うことで、 `print` や `join` のように、「特定の処理を行うコード」をひとかたまりにして、 簡単に呼ぶことが出来るようになります。

___
## サブルーチン
### サブルーチンの定義
それでは、早速サブルーチンを定義していきましょう。

今回は、末尾に自動的に改行(`\n`)を付与しながら文字列を表示する `say` というサブルーチンを定義してみます。

___
## サブルーチン
### サブルーチンの定義
```perl
sub say {               # -┐
    my $str = shift @_; #  │ サブルーチン say を
    print "$str\n";     #  │ 定義しているところ
}                       # -┘
say("hello, world!"); # hello, world!
```

Perlでサブルーチンを定義する為には、`sub サブルーチン名 { ... }` と書きます。

それでは、詳しく見て行きましょう。

___
## サブルーチン
### サブルーチンの命名規則
```perl
sub say { ... }
```

- 末尾の `}` の後に、 `;` を書く必要はありません。

- サブルーチン名として使える文字は以下です。
  - 大文字・小文字の英数字
  - アンダースコア(`_`)

- ただし、サブルーチン名の先頭文字には以下の制限があります。
  - 英文字
  - `_`

これは変数名と同じルールです。

___
## サブルーチン
### Perlにおけるサブルーチンの命名規則
```perl
sub say_hello_world { ... }

sub say_good_morning { ... }
```

複数の単語でサブルーチン名を構築する時は、このように単語間を `_` で繋げる場合が多いです。

このような `_` で単語をつなげる記法をスネークケース（snake_case）といいます。

Perlでは基本的にスネークケースを推奨しています。

___
## サブルーチン
### サブルーチン命名規則クイズ
```perl
sub hoge!    { ... }

sub _hoge    { ... }

sub 123_hoge    { ... }

sub hoge_123 { ... }
```

この中で、サブルーチン名として正しいものはどれでしょうか？

___
## サブルーチン
### サブルーチン命名規則クイズの正解
```perl
sub hoge!    { ... }    # 記号 '!' はサブルーチン名に使えない

sub _hoge    { ... }

sub 123_hoge    { ... } # 先頭は 英字 or '_' のみ
                        # 数字は先頭に使えない
sub hoge_123 { ... }
```

正解は `_hoge` と `hoge_123` です。

___
## サブルーチン
### サブルーチンの呼び出し
```perl
say('Hello Perl');
```

定義したサブルーチンは、定義したサブルーチン名の後ろに `()` を付けることで利用できます。

行末に書く場合には、 ` ; ` が必要です。

このようにサブルーチンを利用することを「**サブルーチンの呼び出し**」といいます。

サブルーチンに値(引数)を渡したい場合、 `()` の中に書きます。

`()` を使わずに, サブルーチン名の先頭に `&` を付けて `&say` で呼びだすこともできますが、古い書き方なので使わないようにしましょう。

___
## サブルーチン
### サブルーチンの引数
```perl
sub say {
    my $str = shift @_; # ←┐
    print "$str\n";     #  │ サブルーチンの引数 'Hello Perl' は
}                       #  │ @_ という配列に格納される
                        #  │
say('Hello Perl');      # ─┘
```

サブルーチンに与えられた引数は、 `@_` という配列に格納されます。

2行目では、`shift` を使って、この　`@_` の先頭の要素を取得しています。

このサブルーチンを `say('hoge');` のように呼んだ場合、 `@_` の中身は`('hoge')` となり、 `$str` には `hoge` という文字列が入ります。

___
## サブルーチン
### サブルーチンの引数
```perl
sub say {
    my $str = shift;  # @_ が省略されている
    print "$str\n";
}

say('Hello Perl');    # Hello Perl
```

`@_` は、省略することができます。

その為、2行目の `my $str = shift;` は、 `my $str = shift @_;` と同じ意味になります。

___
## サブルーチン
### サブルーチンの位置
```perl
say('Hello Perl');  # Hello Perl

sub say {
    my $str = shift;
    print "$str\n";
}
```

同じファイル内であれば、サブルーチンの位置にかかわらず `say('hoge');` として呼び出すことができます。

ファイル末尾にサブルーチンがまとまっている方が見やすい場合は、このスタイルで書きましょう。

___
## サブルーチン
### サブルーチン「add」を作る
```perl
sub add {                     # ┐
    my ($left, $right) = @_;  # │サブルーチン add の定義部
    return $left + $right;    # │
}                             # ┘

my $result = add(2, 5);       # サブルーチン add の呼び出し
print $result . "\n";   # 7
```

次に、2つの引数を受け取り、その和を返すサブルーチン `add` を考えてみることにします。

`add` サブルーチンの定義と呼び出しは、このように書くことができます。

___
## サブルーチン
### サブルーチンに複数の引数を渡す
```perl
sub add {
    my ($left, $right) = @_;  # @_ の中に 2, 5が入る
    return $left + $right;    # ↑
}                             # │
                              # │
my $result = add(2, 5);       # ┘ add の引数 2, 5
print $result . "\n";   # 7
```

サブルーチンに複数の引数が与えられた場合(この場合は `2` と `5` )、サブルーチン側ではこのようにして受け取ることができます。

サブルーチンに複数の引数を与える時は、` ( ) ` の中で配列のようにカンマ　`,` で区切って渡します。

___
## サブルーチン
### サブルーチン側の引数の受け取り方
```perl
sub add {
                        # @_ を省略した場合
    my $left  = shift;  # @_ の先頭から1つ取り出して変数に入れている
    my $right = shift;  # @_ の先頭から1つ取り出して変数に入れている
    return $left + $right;
}
my $result = add(2, 5);
```
```perl
sub add {
    my $left  = $_[0];  # $_[0] : @_ の最初の要素
    my $right = $_[1];  # $_[1] : @_ の次の要素
    return $left + $right;
}
my $result = add(2, 5);
```

先程の引数の受け取り方は、上記のコードと同じ意味になります。

___
## サブルーチン
### 返り値とreturn
```perl
sub add {
    my ($left, $right) = @_;
    return $left + $right;  # $left + $right の結果を返す
}
my $result = add(2, 5);
print $result . "\n";   # 7
```

サブルーチンは, `return` を使うことで、任意のデータを呼び出し元へ返すことができます。

サブルーチンや関数の処理結果のことを **<ruby>返り値<rt>かえりち</rt></ruby>** といいます。

この場合、 `$left + $right` の計算結果が呼び出し元へ返され、 `$result` に格納されます。

___
## サブルーチン
### 複数のreturn
```perl
sub is_same {
    my ( $left, $right ) = @_;
    if ( $left eq $right ) {
        print "true\n";    # $left と $right が等しければ表示
        return 1;
    }
    else {
        print "false\n";    # $left と $right が異なれば表示
        return 0;
    }
    print "YOU WILL NEVER SEE IT\n"; # 絶対に表示されない!
    return;
}
```

`return`はサブルーチンの中に複数個書くことができます。

`return`に到達した場合、それ以降の処理は一切行われず、すぐさま値を返してサブルーチンの実行を終了します。（ガード節といいます）

___
## サブルーチン
### 複数の返り値
```perl
sub add_and_min {
    my ( $left, $right ) = @_;
    return ( $left + $right, $left - $right );
}
my ( $add, $min ) = add_and_min( 5, 4 );
```

サブルーチンは、このようにリストを返すことで複数個の値を返すこともできます。

引数がどのようにサブルーチンに渡されて処理されるか、追ってみましょう。

___
## サブルーチン
## returnがない場合の返り値
```perl
sub add {
    my ($left, $right) = @_;
    $left + $right;         # サブルーチンの中で最後に評価された行
}

my $result = add(2, 5);
print $result . "\n";   # 7
```

サブルーチンの中に `return` がない場合、サブルーチンの返り値は最後に評価された処理の結果(この場合、 `$left + $right`の計算結果)を返します。

値を返すという意図を明確にするため、 `return` は書くようにしましょう。

___
## 練習問題
次のようなサブルーチンを持つコードを `simple_calc.pl` という名前で作成しよう。

- 2つの引数の和（足し算）を計算する `add`
- 2つの引数の差（引き算）を計算する `min`
- 2つの引数の積（掛け算）を計算する `mul`
- 2つの引数の商（割り算）を計算する `div`

これらのサブルーチンが正しく実装できているか(与えた2つの引数に対して, 適切な値を返すか)を確認するコードも一緒に書くこと。

- 時間の余った人は「0」で割った際のエラーを回避する仕組みを入れてみよう

- さらに時間の余った人は数字以外が入力された場合に 'INPUT NUMBER PLEASE'と表示する仕組みを入れてみよう
